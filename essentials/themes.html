<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Themes — EchoSearch</title>
  <link rel="canocial" href="https://echo-search.github.io/essentials/themes.html" />
<style>
:root { --bg: #f5f7f9; --card: #ffffff; --muted: #666d75; --accent: #00b7b0; --accent-dark: #009688; --danger: #dc3545; --radius: 10px; --shadow: 0 6px 18px rgba(15, 23, 42, 0.06); --gap: 14px; --max-w: 980px; --ui-font: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
html,body { height:100%; }
body { margin:0; font-family: var(--ui-font); background: linear-gradient(180deg, var(--bg), #eef2f5); color:#111827; padding:28px; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
.container { max-width: var(--max-w); margin: 0 auto; }
header { display:flex; justify-content:space-between; align-items:center; gap:var(--gap); margin-bottom:18px; }
h1 { margin:0; font-size:20px; letter-spacing:-0.2px; }
.subtitle { color:var(--muted); font-size:0.95rem; margin-top:4px; }
.panel { background: var(--card); border-radius: var(--radius); padding:18px; box-shadow: var(--shadow); margin-bottom:18px; border:1px solid rgba(16,24,40,0.03); }
.create-grid { display:grid; grid-template-columns: 1fr 220px; gap:18px; align-items:start; }
.controls { display:flex; flex-direction:column; gap:10px; }
label { display:block; font-weight:600; color:#111827; font-size:0.92rem; margin-bottom:6px; }
.inputs { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
input[type="text"] { padding:9px 10px; border-radius:8px; border:1px solid #e6e9ee; width:100%; box-sizing:border-box; font-size:0.95rem; background:#fff; }
input[type="color"] { width:46px; height:38px; padding:0; border-radius:8px; border:1px solid #e6e9ee; cursor:pointer; }
input[type="file"] { font-size:0.9rem; }
.preview { min-height:120px; border-radius:8px; border:1px solid #e6e9ee; display:flex; align-items:center; justify-content:center; text-align:center; color:#0f1724; font-weight:600; overflow:hidden; }
.preview .title { background: rgba(255,255,255,0.6); padding:6px 10px; border-radius:6px; font-size:0.98rem; }
.btn-row { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
button { font-size:0.95rem; padding:9px 12px; border-radius:8px; border:0; cursor:pointer; }
.btn-primary { background:var(--accent); color:#fff; box-shadow: 0 6px 14px rgba(0,0,0,0.06); }
.btn-ghost { background:#f7fafc; color:#111827; border:1px solid #eef2f4; }
.btn-danger { background:var(--danger); color:#fff; }
#themesUL { list-style:none; padding:0; margin:0; display:grid; gap:12px; }
.theme-item { display:flex; gap:12px; align-items:center; padding:12px; border-radius:10px; background:white; border:1px solid rgba(16,24,40,0.03); box-shadow: 0 2px 8px rgba(15, 23, 42, 0.03); }
.left-col { display:flex; gap:12px; align-items:center; min-width:0; }
.swatch { width:64px; height:64px; border-radius:8px; border:1px solid #eef2f4; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; font-size:14px; overflow:hidden; }
.meta { font-size:0.95rem; color:var(--muted); margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:420px; }
.title { font-weight:700; color:#0b1220; }
.actions { margin-left:auto; display:flex; gap:8px; align-items:center; }
.icon-btn { width:40px; height:40px; display:inline-grid; place-items:center; border-radius:8px; border:1px solid transparent; background:transparent; cursor:pointer; }
.icon-btn:hover { background:#f8fafc; border-color:#eef2f4; }
.icon-edit { color: #0b1220; }
.icon-delete { color: var(--danger); }
.empty { padding:28px; text-align:center; color:var(--muted); border-radius:8px; background:linear-gradient(180deg, rgba(0,0,0,0.01), transparent); border:1px dashed rgba(16,24,40,0.04); }
.toolbar { display:flex; gap:8px; align-items:center; }
.back-button { display:inline-block; padding:10px 14px; border-radius:8px; background:transparent; color:var(--muted); text-decoration:none; border:1px solid transparent; font-weight:600; }
@media (max-width:880px) { .create-grid { grid-template-columns: 1fr; } 
.swatch { width:52px; height:52px; } }

</style>
</head>
<body>
  <div class="container">

    <header>
      <div>
        <h1>Themes</h1>
        <div class="subtitle">Create and manage your custom themes for EchoSearch.</div>
      </div>

      <div class="toolbar" aria-hidden="false">
        <a class="back-button" href="/">‹ Back to Home</a>
      </div>
    </header>

    <section class="panel" aria-labelledby="createHeading">
      <div class="create-grid">
        <div class="controls">
          <div>
            <div id="createHeading" style="font-weight:700;margin-bottom:6px">Create a custom theme</div>
            <input id="themeName" type="text" placeholder="e.g. My Minty Theme" aria-label="Theme name"/>
          </div>

          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:8px">
            <div>
              <label for="bgColor">Background</label>
              <input id="bgColor" type="color" value="#ffffff" aria-label="Background color"/>
            </div>

            <div>
              <label for="accentColor">Button</label>
              <input id="accentColor" type="color" value="#00cec9" aria-label="Accent color"/>
            </div>

            <div>
              <label for="textColor">Text</label>
              <input id="textColor" type="color" value="#000000" aria-label="Text color"/>
            </div>
          </div>

          <div style="margin-top:10px">
            <label for="bgImage">Background image (optional)</label>
            <input id="bgImage" type="file" accept="image/*"/>
          </div>

          <div class="btn-row">
            <button id="saveBtn" class="btn-primary" type="button">Save theme</button>
            <button id="resetBtn" class="btn-ghost" type="button">Reset</button>
          </div>

          <div style="margin-top:6px;color:var(--muted);font-size:0.92rem">Tip: Saved themes are stored in you browser. You can edit or delete them below (unless there aren't any).</div>
        </div>

        <aside>
          <div class="preview" id="preview" aria-hidden="false"><div class="title">Preview</div></div>
        </aside>
      </div>
    </section>

    <section class="panel" aria-labelledby="listHeading">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div>
          <strong id="listHeading">Custom themes</strong>
          <div class="subtitle" style="margin-top:4px">Only your saved themes appear here.</div>
        </div>
        <div>
          <button id="clearCustoms" class="btn-ghost" type="button" title="Remove all custom themes">Clear all</button>
        </div>
      </div>

      <ul id="themesUL" aria-live="polite" aria-relevant="additions removals"></ul>
    </section>

    <script src="/essentials/firebase-sync.js"></script>

    <script>
    (function () {
      'use strict';

      const STORAGE_BASE_KEY = 'customThemes';

      function getLocalKey(base) {
        try {
          if (window.__echosearchFirebaseSync && typeof window.__echosearchFirebaseSync.getLocalKey === 'function') {
            return window.__echosearchFirebaseSync.getLocalKey(base);
          }
        } catch (e) {}
        return base;
      }

      function getStorageKey() {
        return getLocalKey(STORAGE_BASE_KEY);
      }

      const themesUL = document.getElementById('themesUL');
      const saveBtn = document.getElementById('saveBtn');
      const resetBtn = document.getElementById('resetBtn');
      const themeNameInput = document.getElementById('themeName');
      const bgColorInput = document.getElementById('bgColor');
      const accentInput = document.getElementById('accentColor');
      const textInput = document.getElementById('textColor');
      const bgFileInput = document.getElementById('bgImage');
      const preview = document.getElementById('preview');
      const clearCustomsBtn = document.getElementById('clearCustoms');

      function loadCustomThemes() {
        try {
          const raw = localStorage.getItem(getStorageKey());
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          console.error('Failed to parse customThemes', e);
          return [];
        }
      }

      function saveCustomThemes(arr) {
        try {
          localStorage.setItem(getStorageKey(), JSON.stringify(arr || []));
        } catch (e) {
          console.error('Failed to save customThemes', e);
        }
      }

      function fileToDataUrl(file) {
        return new Promise((res, rej) => {
          if (!file) return res('');
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.onerror = (e) => rej(e);
          reader.readAsDataURL(file);
        });
      }

      function hexToRgb(hex) {
        if (!hex) throw new Error('Invalid color');
        hex = hex.replace('#', '');
        if (hex.length === 3) {
          hex = hex.split('').map(c => c + c).join('');
        }
        const bigint = parseInt(hex, 16);
        return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
      }
      function rgbToHsl(r, g, b) {
        r /= 255; g /= 255; b /= 255;
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h = 0, s = 0, l = (max + min) / 2;
        if (max !== min) {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
          }
          h /= 6;
        }
        return { h, s, l };
      }
      function hslToRgb(h, s, l) {
        let r, g, b;
        if (s === 0) {
          r = g = b = l;
        } else {
          const hue2rgb = function (p, q, t) {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            if (t < 1/6) return p + (q - p) * 6 * t;
            if (t < 1/2) return q;
            if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
          };
          const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
          const p = 2 * l - q;
          r = hue2rgb(p, q, h + 1/3);
          g = hue2rgb(p, q, h);
          b = hue2rgb(p, q, h - 1/3);
        }
        return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
      }
      function rgbToHex(rgb) {
        return '#' + [rgb.r, rgb.g, rgb.b].map(v => v.toString(16).padStart(2, '0')).join('');
      }
      function computeHover(hex) {
        try {
          const rgb = hexToRgb(hex || '#00cec9');
          const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
          hsl.l = Math.max(0, hsl.l - 0.12);
          const darker = hslToRgb(hsl.h, hsl.s, hsl.l);
          return rgbToHex(darker);
        } catch (e) {
          console.warn('computeHover failed, falling back to provided color', e);
          return hex;
        }
      }

      let selectedBgDataUrl = '';
      function updatePreview() {
        preview.style.backgroundImage = '';
        preview.style.backgroundSize = 'cover';
        preview.style.backgroundPosition = 'center';
        preview.style.color = textInput.value || '#000';
        if (selectedBgDataUrl) {
          preview.style.backgroundImage = `url("${selectedBgDataUrl}")`;
          preview.innerHTML = '';
          return;
        }
        const bg = bgColorInput.value || '#ffffff';
        preview.style.background = bg;
        preview.innerHTML = '<div class="title">' + (themeNameInput.value || 'Preview') + '</div>';
      }

      bgFileInput.addEventListener('change', async (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) {
          selectedBgDataUrl = '';
          updatePreview();
          return;
        }
        try {
          selectedBgDataUrl = await fileToDataUrl(f);
          updatePreview();
        } catch (err) {
          console.error('Error reading file', err);
          selectedBgDataUrl = '';
        }
      });

      function renderList() {
        themesUL.innerHTML = '';
        const customs = loadCustomThemes();

        if (!customs || customs.length === 0) {
          const li = document.createElement('li');
          li.className = 'empty';
          li.innerHTML = '<div style="font-weight:700;margin-bottom:6px">No custom themes yet</div>' +
                         '<div style="color:var(--muted)">Create one using the panel above — it will appear here instantly.</div>';
          themesUL.appendChild(li);
          return;
        }

        customs.forEach((t, idx) => {
          const li = document.createElement('li');
          li.className = 'theme-item';

          const left = document.createElement('div');
          left.className = 'left-col';

          const sw = document.createElement('div');
          sw.className = 'swatch';
          if (t.bgImage) {
            sw.style.backgroundImage = `url("${t.bgImage}")`;
            sw.style.backgroundSize = 'cover';
            sw.style.backgroundPosition = 'center';
            sw.textContent = '';
          } else if (t.bgColor) {
            sw.style.background = t.bgColor;
            sw.textContent = (t.name && t.name[0]) ? t.name[0].toUpperCase() : '';
          } else {
            sw.style.background = '#e6e9ee';
            sw.textContent = (t.name && t.name[0]) ? t.name[0].toUpperCase() : '';
          }
          left.appendChild(sw);

          const txt = document.createElement('div');
          txt.style.minWidth = '0';
          const title = document.createElement('div');
          title.className = 'title';
          title.textContent = t.name || `Custom ${idx + 1}`;
          const meta = document.createElement('div');
          meta.className = 'meta';
          const parts = [];
          if (t.accent) parts.push(`accent ${t.accent}`);
          if (t.textColor) parts.push(`text ${t.textColor}`);
          if (t.hover) parts.push(`hover ${t.hover}`);
          meta.textContent = parts.join(' • ');
          txt.appendChild(title);
          txt.appendChild(meta);
          left.appendChild(txt);

          li.appendChild(left);

          const actions = document.createElement('div');
          actions.className = 'actions';

          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'icon-btn';
          editBtn.title = 'Edit theme';
          editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="12" height="12" viewBox="0 0 256 256" xml:space="preserve"><g sty[...]
          editBtn.addEventListener('click', () => {
            themeNameInput.value = t.name || '';
            bgColorInput.value = t.bgColor || '#ffffff';
            accentInput.value = t.accent || '#00cec9';
            textInput.value = t.textColor || '#000000';
            if (t.bgImage) {
              selectedBgDataUrl = t.bgImage;
              preview.style.backgroundImage = `url("${t.bgImage}")`;
              preview.innerHTML = '';
            } else {
              selectedBgDataUrl = '';
              preview.style.background = t.bgColor || '#fff';
              preview.innerHTML = '<div class="title">' + (t.name || 'Preview') + '</div>';
            }
            const arr = loadCustomThemes();
            arr.splice(idx, 1);
            saveCustomThemes(arr);
            renderList();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
          actions.appendChild(editBtn);

          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'icon-btn';
          delBtn.title = 'Delete theme';
          delBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="12" height="12" viewBox="0 0 256 256" xml:space="preserve"><g styl[...]
          delBtn.addEventListener('click', () => {
            if (!confirm(`Delete custom theme "${t.name || 'Custom'}"?`)) return;
            const arr = loadCustomThemes();
            arr.splice(idx, 1);
            saveCustomThemes(arr);
            renderList();
          });
          actions.appendChild(delBtn);

          li.appendChild(actions);
          themesUL.appendChild(li);
        });
      }

      saveBtn.addEventListener('click', async () => {
        const name = (themeNameInput.value || '').trim() || `Custom ${Date.now()}`;
        const accent = accentInput.value || '#00cec9';
        const hoverColor = computeHover(accent);
        const newTheme = {
          name,
          bgColor: bgColorInput.value || '#ffffff',
          accent: accent,
          hover: hoverColor,
          textColor: textInput.value || '',
          bgImage: selectedBgDataUrl || ''
        };
        const arr = loadCustomThemes();
        arr.push(newTheme);
        saveCustomThemes(arr);
        renderList();
        themeNameInput.value = '';
        bgFileInput.value = '';
        selectedBgDataUrl = '';
        preview.style.backgroundImage = '';
        preview.style.background = '#fff';
        preview.innerHTML = '<div class="title">Preview</div>';
        try { localStorage.setItem(getStorageKey() + ':sync', Date.now().toString()); } catch(e){}
      });

      resetBtn.addEventListener('click', () => {
        themeNameInput.value = '';
        bgColorInput.value = '#ffffff';
        accentInput.value = '#00cec9';
        textInput.value = '#000000';
        bgFileInput.value = '';
        selectedBgDataUrl = '';
        preview.style.backgroundImage = '';
        preview.style.background = '#fff';
        preview.innerHTML = '<div class="title">Preview</div>';
      });

      clearCustomsBtn.addEventListener('click', () => {
        if (!confirm('Remove all custom themes?')) return;
        saveCustomThemes([]);
        renderList();
      });

      window.addEventListener('storage', (e) => {
        if (!e.key) return;
        const k = getStorageKey();
        if (e.key === k || e.key === k + ':sync') {
          renderList();
        }
      });
      renderList();
      updatePreview();

      window.addCustomTheme = function(themeObj) {
        if (!themeObj || typeof themeObj !== 'object') {
          throw new Error('addCustomTheme requires an object');
        }
        const acc = themeObj.accent || themeObj.accentColor || '#00cec9';
        themeObj.hover = themeObj.hover || computeHover(acc);
        const arr = loadCustomThemes();
        arr.push(themeObj);
        saveCustomThemes(arr);
        renderList();
      };
    })();
</script>
</body>
</html>
