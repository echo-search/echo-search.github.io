<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Search History â€” EchoSearch</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;margin:1rem;color:#222}
    h1{margin-bottom:0.5rem}
    .controls{margin:1rem 0;display:flex;gap:.5rem;flex-wrap:wrap}
    button{padding:.45rem .75rem;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .danger{background:#ffebe9;border-color:#ffb6b0}
    .history-list{list-style:none;padding:0;margin:0}
    .history-item{display:flex;align-items:center;justify-content:space-between;padding:.5rem;border-bottom:1px solid #f0f0f0}
    .meta{color:#666;font-size:.9rem}
    .item-left{display:flex;flex-direction:column;gap:.25rem}
    .item-actions{display:flex;gap:.5rem}
    .empty{color:#666;padding:1rem}
    .search-filter{display:flex;gap:.5rem;align-items:center}
    input[type="text"]{padding:.4rem .6rem;border:1px solid #ccc;border-radius:6px}
    .minor{font-size:.85rem;color:#777}
  </style>
</head>
<body>
  <h1>Search History</h1>
  <p class="minor">All searches are stored locally in your browser. Use the controls below to remove items or clear ranges.</p>

  <div class="controls">
    <div class="search-filter">
      <label for="filterText">Filter:</label>
      <input id="filterText" type="text" placeholder="Filter queries..." />
    </div>
    <button id="btnDelete24">Delete last 24 hours</button>
    <button id="btnDelete7d">Delete last 7 days</button>
    <button id="btnDelete30d">Delete last 30 days</button>
    <button id="btnClearAll" class="danger">Delete all</button>
    <button id="btnExport">Export JSON</button>
  </div>

  <ul id="historyList" class="history-list" aria-live="polite"></ul>
  <div id="empty" class="empty" style="display:none">No history found.</div>

  <script src="essentials/history-manager.js"></script>
  <script>
    (function(){
      const HM = window.HistoryManager;
      if(!HM) return console.warn('HistoryManager missing');

      const listEl = document.getElementById('historyList');
      const emptyEl = document.getElementById('empty');
      const filterInput = document.getElementById('filterText');

      function render() {
        const entries = HM.getAll();
        const filter = filterInput.value.trim().toLowerCase();

        listEl.innerHTML = '';
        const filtered = entries.filter(e => (!filter) || e.query.toLowerCase().includes(filter));
        if(filtered.length === 0) {
          emptyEl.style.display = 'block';
          return;
        } else emptyEl.style.display = 'none';

        filtered.forEach(entry => {
          const li = document.createElement('li');
          li.className = 'history-item';

          const left = document.createElement('div');
          left.className = 'item-left';
          const q = document.createElement('div');
          q.textContent = entry.query;
          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.textContent = 'Searched: ' + HM.formatTs(entry.ts);

          left.appendChild(q);
          left.appendChild(meta);

          const actions = document.createElement('div');
          actions.className = 'item-actions';

          const btnSearch = document.createElement('button');
          btnSearch.textContent = 'Search again';
          btnSearch.addEventListener('click', () => {
            // Hint: replace with your search invocation
            if(window.doSearch) window.doSearch(entry.query);
            else alert('Call your search function with: ' + entry.query);
          });

          const btnDel = document.createElement('button');
          btnDel.textContent = 'Delete';
          btnDel.addEventListener('click', () => {
            if(confirm('Delete this entry?')) {
              HM.deleteById(entry.id);
              render();
            }
          });

          actions.appendChild(btnSearch);
          actions.appendChild(btnDel);

          li.appendChild(left);
          li.appendChild(actions);
          listEl.appendChild(li);
        });
      }

      // Buttons
      document.getElementById('btnDelete24').addEventListener('click', () => {
        if(confirm('Delete all entries from the last 24 hours?')) {
          const ms = 24 * 60 * 60 * 1000;
          HM.deleteRange(ms);
          render();
        }
      });

      document.getElementById('btnDelete7d').addEventListener('click', () => {
        if(confirm('Delete all entries from the last 7 days?')) {
          const ms = 7 * 24 * 60 * 60 * 1000;
          HM.deleteRange(ms);
          render();
        }
      });

      document.getElementById('btnDelete30d').addEventListener('click', () => {
        if(confirm('Delete all entries from the last 30 days?')) {
          const ms = 30 * 24 * 60 * 60 * 1000;
          HM.deleteRange(ms);
          render();
        }
      });

      document.getElementById('btnClearAll').addEventListener('click', () => {
        if(confirm('Delete all history?')) {
          HM.clearAll();
          render();
        }
      });

      document.getElementById('btnExport').addEventListener('click', () => {
        const data = JSON.stringify(HM.getAll(), null, 2);
        const blob = new Blob([data], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'search-history.json';
        a.click();
        URL.revokeObjectURL(url);
      });

      filterInput.addEventListener('input', render);

      // Initial render
      render();

      // Re-render if history changes elsewhere (e.g., other tabs) using storage event
      window.addEventListener('storage', (e) => {
        if(e.key === HM.storageKey) render();
      });
    })();
  </script>
</body>
</html>
