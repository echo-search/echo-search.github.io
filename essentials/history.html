<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lifetime Search History — EchoSearch</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #fafafa;
    }
    h1 {
      margin-bottom: 15px;
    }
    details {
      border: 1px solid #ccc;
      border-radius: 10px;
      background: white;
      margin-bottom: 22px;
      padding: 5px 12px 12px 12px;
      position: relative;
    }
    summary {
      font-size: 1.25rem;
      font-weight: 600;
      cursor: pointer;
      padding: 10px 0;
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    summary::-webkit-details-marker {
      display: none;
    }
    .day-delete {
      font-size: 1rem;
      cursor: pointer;
      color: #999;
      margin-left: 10px;
    }
    .day-delete:hover {
      color: #d33;
    }
    .history-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 1rem;
    }
    .row-left {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    .query {
      flex: 1;
      margin-right: 8px;
      word-break: break-word;
    }
    .time {
      font-size: 0.85rem;
      color: #777;
      white-space: nowrap;
      margin-left: 10px;
    }
    .entry-delete {
      color: #999;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 12px;
    }
    .entry-delete:hover {
      color: #d33;
    }
    .divider {
      width: 100%;
      height: 1px;
      background: #ddd;
      opacity: 0.55;
      margin: 4px 0 6px;
    }
    ul, li {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .toolbar {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button, select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #888;
      cursor: pointer;
      background: white;
    }
    .back-button {
      display: inline-block;
      margin-top: 40px;
      padding: 10px 20px;
      background-color: #00cec9;
      color: black;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      transition: background 0.3s ease;
    }
    .back-button svg {
      vertical-align: middle;
      margin-left: 8px;
      fill: currentColor;
    }
  </style>
</head>

<body>
  <h1>Lifetime Search History</h1>

  <div class="toolbar">
    <select id="deleteRange">
      <option value="">Delete by range…</option>
      <option value="24h">Last 24 hours</option>
      <option value="7d">Last 7 days</option>
      <option value="30d">Last 30 days</option>
      <option value="365d">Last 365 days</option>
    </select>

    <button id="exportBtn">Export JSON</button>
  </div>

  <div id="lifetime"></div>

  <a href="/" class="back-button" aria-label="Back to home">‹ Back to Home <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="16" height="16" viewBox="0 0 256 256" xml:space="preserve"><g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)"><polygon points="75.96,30.96 75.96,13.34 67.26,13.34 67.26,22.26 45,0 0.99,44.02 7.13,50.15 45,12.28 82.88,50.15 89.01,44.02 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/><polygon points="45,20 14.04,50.95 14.04,90 35.29,90 35.29,63.14 54.71,63.14 54.71,90 75.96,90 75.96,50.95 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/></g></svg></a>

  <script src="/essentials/firebase-sync.js"></script>

  <script>
const CONTAINER_ID = "lifetime";
const DELETE_RANGE_SELECT_ID = "deleteRange";
const EXPORT_BUTTON_ID = "exportBtn";

const STORAGE_KEY = "lifetimeHistory";

/**
 * Centralized notifier so event creation is consistent and avoids accidental reuse of the same Event object.
 */
function notifyHistoryUpdated() {
  document.dispatchEvent(new Event("history-updated"));
}

function saveLifetime(query) {
  const entry = { query, time: new Date().toISOString() };
  const life = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  life.unshift(entry);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(life));
  notifyHistoryUpdated();
}

function formatDateHeader(dateObj) {
  const d = dateObj.getDate();
  const suffix =
    d % 10 === 1 && d !== 11 ? "st" :
    d % 10 === 2 && d !== 12 ? "nd" :
    d % 10 === 3 && d !== 13 ? "rd" : "th";

  // use en-GB for correct UK-style formatting
  return dateObj.toLocaleDateString("en-GB", {
    weekday: "long",
    month: "long",
    day: "numeric"
  }).replace(/\d+/, `${d}${suffix}`);
}

function getLifetimeGrouped() {
  const life = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  const groups = {};

  life.forEach((e, idx) => {
    // handle numeric timestamps as well as ISO strings
    const d = new Date(e.time);
    const header = formatDateHeader(d);
    if (!groups[header]) groups[header] = [];
    groups[header].push({...e, index: idx});
  });

  return groups;
}

function deleteRange(range) {
  const now = Date.now();
  const ranges = {
    "24h": now - 24*60*60*1000,
    "7d": now - 7*24*60*60*1000,
    "30d": now - 30*24*60*60*1000,
    "365d": now - 365*24*60*60*1000
  };

  const rangeLabels = {
    "24h": "last 24 hours",
    "7d": "last 7 days",
    "30d": "last 30 days",
    "365d": "last 365 days"
  };

  if (!ranges[range]) return;

  const confirmed = confirm(`Delete Search History from the ${rangeLabels[range]}?`);
  
  if (!confirmed) return;

  const life = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  // keep items older than the cutoff; this deletes items from the specified recent range
  const filtered = life.filter(e => {
    const t = (typeof e.time === "number") ? e.time : new Date(e.time).getTime();
    return t < ranges[range];
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
  notifyHistoryUpdated();
}

function exportLifetimeHistory() {
  const life = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

  const normalized = life.map(e => {
    return {
      ...e,
      time: new Date(e.time).toISOString()
    };
  });

  const blob = new Blob([JSON.stringify(normalized, null, 2)], {
    type: "application/json"
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "echosearch-lifetime-history.json";
  a.click();
  URL.revokeObjectURL(url);
}

function deleteEntry(index) {
  let life = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  if (index < 0 || index >= life.length) return;
  life.splice(index, 1);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(life));
  notifyHistoryUpdated();
}

function deleteEntireDay(day) {
  let life = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

  const filtered = life.filter(e => {
    const d = formatDateHeader(new Date(e.time));
    return d !== day;
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
  notifyHistoryUpdated();
}

function escapeHTML(s) {
  return String(s || "").replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#39;");
}

function render() {
  const container = document.getElementById(CONTAINER_ID);
  const groups = getLifetimeGrouped();
  container.innerHTML = "";

  // sort days by newest first using the first entry's timestamp in each group
  let days = Object.keys(groups);
  days = days.sort((a, b) => {
    const ta = new Date(groups[a][0].time).getTime();
    const tb = new Date(groups[b][0].time).getTime();
    return tb - ta;
  });

  days.forEach((day, index) => {
    const isLatest = index === 0;

    const details = document.createElement("details");
    if (isLatest) details.open = true;

    const escapedDay = escapeHTML(day);
    const escapedForJS = day.replace(/\\/g, "\\\\").replace(/'/g, "\\'");

    const entriesHTML = groups[day].map(e => {
      const time = new Date(e.time).toLocaleTimeString("en-GB", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });

      return `
        <div class="history-row">
          <span class="query">${escapeHTML(e.query)}</span>
          <span class="time">${time}</span>
          <span class="entry-delete" onclick="deleteEntry(${e.index})" title="Delete entry">&times;</span>
        </div>
        <div class="divider"></div>
      `;
    }).join("");

    details.innerHTML = `
      <summary>
        ${escapedDay}
        <span class="day-delete" onclick="(function(ev){ ev = ev || window.event; if(ev && ev.stopPropagation) ev.stopPropagation(); deleteEntireDay('${escapedForJS}'); })(event);" title="Delete all entries for this day"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="24" height="24" viewBox="0 0 256 256" xml:space="preserve"><g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)"><path d="M 64.71 90 H 25.291 c -4.693 0 -8.584 -3.67 -8.859 -8.355 l -3.928 -67.088 c -0.048 -0.825 0.246 -1.633 0.812 -2.234 c 0.567 -0.601 1.356 -0.941 2.183 -0.941 h 59.002 c 0.826 0 1.615 0.341 2.183 0.941 c 0.566 0.601 0.86 1.409 0.813 2.234 l -3.928 67.089 C 73.294 86.33 69.403 90 64.71 90 z M 18.679 17.381 l 3.743 63.913 C 22.51 82.812 23.771 84 25.291 84 H 64.71 c 1.52 0 2.779 -1.188 2.868 -2.705 l 3.742 -63.914 H 18.679 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(191,46,46); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 80.696 17.381 H 9.304 c -1.657 0 -3 -1.343 -3 -3 s 1.343 -3 3 -3 h 71.393 c 1.657 0 3 1.343 3 3 S 82.354 17.381 80.696 17.381 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(191,46,46); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 58.729 17.381 H 31.271 c -1.657 0 -3 -1.343 -3 -3 V 8.789 C 28.271 3.943 32.214 0 37.061 0 h 15.879 c 4.847 0 8.789 3.943 8.789 8.789 v 5.592 C 61.729 16.038 60.386 17.381 58.729 17.381 z M 34.271 11.381 h 21.457 V 8.789 C 55.729 7.251 54.478 6 52.939 6 H 37.061 c -1.538 0 -2.789 1.251 -2.789 2.789 V 11.381 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(191,46,46); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 58.33 74.991 c -0.06 0 -0.118 -0.002 -0.179 -0.005 c -1.653 -0.097 -2.916 -1.517 -2.819 -3.171 l 2.474 -42.244 c 0.097 -1.655 1.508 -2.933 3.171 -2.819 c 1.653 0.097 2.916 1.516 2.819 3.17 l -2.474 42.245 C 61.229 73.761 59.906 74.991 58.33 74.991 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(191,46,46); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 31.669 74.991 c -1.577 0 -2.898 -1.23 -2.992 -2.824 l -2.473 -42.245 c -0.097 -1.654 1.165 -3.073 2.819 -3.17 c 1.646 -0.111 3.073 1.165 3.17 2.819 l 2.473 42.244 c 0.097 1.654 -1.165 3.074 -2.819 3.171 C 31.788 74.989 31.729 74.991 31.669 74.991 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(191,46,46); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 45 74.991 c -1.657 0 -3 -1.343 -3 -3 V 29.747 c 0 -1.657 1.343 -3 3 -3 c 1.657 0 3 1.343 3 3 v 42.244 C 48 73.648 46.657 74.991 45 74.991 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(191,46,46); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/></g></svg></span>
      </summary>
      ${entriesHTML}
    `;

    container.appendChild(details);
  });
}

const container = document.getElementById(CONTAINER_ID);
const deleteRangeSel = document.getElementById(DELETE_RANGE_SELECT_ID);
const exportBtn = document.getElementById(EXPORT_BUTTON_ID);

document.addEventListener("history-updated", render);
render();

if (deleteRangeSel) {
  deleteRangeSel.addEventListener("change", () => {
    if (!deleteRangeSel.value) return;
    deleteRange(deleteRangeSel.value);
    deleteRangeSel.value = "";
  });
}

if (exportBtn) {
  exportBtn.addEventListener("click", exportLifetimeHistory);
}
  </script>
</body>
</html>
