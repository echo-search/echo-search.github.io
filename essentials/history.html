<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lifetime Search History — EchoSearch</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #fafafa;
    }

    h1 {
      margin-bottom: 15px;
    }

    details {
      border: 1px solid #ccc;
      border-radius: 10px;
      background: white;
      margin-bottom: 22px;
      padding: 5px 12px 12px 12px;
      position: relative;
    }

    summary {
      font-size: 1.25rem;
      font-weight: 600;
      cursor: pointer;
      padding: 10px 0;
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    .day-delete {
      font-size: 1rem;
      cursor: pointer;
      color: #999;
      margin-left: 10px;
    }

    .day-delete:hover {
      color: #d33;
    }

    .history-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 1rem;
    }

    .row-left {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .query {
      flex: 1;
      margin-right: 8px;
    }

    .time {
      font-size: 0.85rem;
      color: #777;
      white-space: nowrap;
      margin-left: 10px;
    }

    .entry-delete {
      color: #999;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 12px;
    }

    .entry-delete:hover {
      color: #d33;
    }

    .divider {
      width: 100%;
      height: 1px;
      background: #ddd;
      opacity: 0.55;
      margin: 4px 0 6px;
    }

    ul, li {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .toolbar {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button, select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #888;
      cursor: pointer;
      background: white;
    }
  </style>
</head>

<body>
  <h1>Lifetime Search History</h1>

  <div class="toolbar">
    <select id="deleteRange">
      <option value="">Delete by range…</option>
      <option value="24h">Last 24 hours</option>
      <option value="7d">Last 7 days</option>
      <option value="30d">Last 30 days</option>
      <option value="365d">Last 365 days</option>
    </select>

    <button id="exportBtn">Export JSON</button>
  </div>

  <div id="lifetime"></div>

  <script src="/essentials/firebase-sync.js"></script>

  <script>
const CONTAINER_ID = "lifetime";
const DELETE_RANGE_SELECT_ID = "deleteRange";
const EXPORT_BUTTON_ID = "exportBtn";

// Default base key (unchanged). We'll resolve per-user key at access time
const STORAGE_BASE_KEY = "lifetimeHistory";

function getLocalKey(base) {
  try {
    if (window.__echosearchFirebaseSync && typeof window.__echosearchFirebaseSync.getLocalKey === 'function') {
      return window.__echosearchFirebaseSync.getLocalKey(base);
    }
  } catch (e) {}
  return base;
}

function getStorageKey() {
  return getLocalKey(STORAGE_BASE_KEY);
}

const PAGE_EVENT = new Event("history-updated");

function saveLifetime(query) {
  const entry = { query, time: Date.now() };
  const key = getStorageKey();
  const life = JSON.parse(localStorage.getItem(key) || "[]");
  life.unshift(entry);
  try {
    localStorage.setItem(key, JSON.stringify(life));
  } catch (e) {
    console.warn('Failed to write lifetime history', e);
  }
  document.dispatchEvent(PAGE_EVENT);
}

function formatDateHeader(dateObj) {
  const d = dateObj.getDate();
  const suffix =
    d % 10 === 1 && d !== 11 ? "st" :
    d % 10 === 2 && d !== 12 ? "nd" :
    d % 10 === 3 && d !== 13 ? "rd" : "th";

  return dateObj.toLocaleDateString("en-UK", {
    weekday: "long",
    month: "long",
    day: "numeric"
  }).replace(/\d+/, `${d}${suffix}`);
}

function getLifetimeGrouped() {
  const key = getStorageKey();
  const life = JSON.parse(localStorage.getItem(key) || "[]");
  const groups = {};

  life.forEach((e, idx) => {
    const d = new Date(e.time);
    const header = formatDateHeader(d);
    if (!groups[header]) groups[header] = [];
    groups[header].push({...e, index: idx});
  });

  return groups;
}

function deleteRange(range) {
  const now = Date.now();
  const ranges = {
    "24h": now - 24*60*60*1000,
    "7d": now - 7*24*60*60*1000,
    "30d": now - 30*24*60*60*1000,
    "365d": now - 365*24*60*60*1000
  };

  const rangeLabels = {
    "24h": "last 24 hours",
    "7d": "last 7 days",
    "30d": "last 30 days",
    "365d": "last 365 days"
  };

  if (!ranges[range]) return;

  const confirmed = confirm(`Delete Search History from the ${rangeLabels[range]}?`);
  
  if (!confirmed) return;

  const key = getStorageKey();
  const life = JSON.parse(localStorage.getItem(key) || "[]");
  const filtered = life.filter(e => e.time < ranges[range]);

  localStorage.setItem(key, JSON.stringify(filtered));
  document.dispatchEvent(PAGE_EVENT);
}

function exportLifetimeHistory() {
  const key = getStorageKey();
  const life = JSON.parse(localStorage.getItem(key) || "[]");

  const blob = new Blob([JSON.stringify(life, null, 2)], {
    type: "application/json"
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "echosearch-lifetime-history.json";
  a.click();
  URL.revokeObjectURL(url);
}

function deleteEntry(index) {
  const key = getStorageKey();
  let life = JSON.parse(localStorage.getItem(key) || "[]");
  life.splice(index, 1);
  localStorage.setItem(key, JSON.stringify(life));
  document.dispatchEvent(PAGE_EVENT);
}

function deleteEntireDay(day) {
  const key = getStorageKey();
  let life = JSON.parse(localStorage.getItem(key) || "[]");

  const filtered = life.filter(e => {
    const d = formatDateHeader(new Date(e.time));
    return d !== day;
  });

  localStorage.setItem(key, JSON.stringify(filtered));
  document.dispatchEvent(PAGE_EVENT);
}

function render() {
  const container = document.getElementById(CONTAINER_ID);
  const groups = getLifetimeGrouped();
  container.innerHTML = "";

  const days = Object.keys(groups);

  days.forEach((day, index) => {
    const isLatest = index === 0;

    const details = document.createElement("details");
    if (isLatest) details.open = true;

    const entriesHTML = groups[day].map(e => {
      const time = new Date(e.time).toLocaleTimeString("en-GB", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });

      return `
        <div class="history-row">
          <span class="query">${e.query}</span>
          <span class="time">${time}</span>
          <span class="entry-delete" onclick="deleteEntry(${e.index})"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="16" height="16" viewBox="[...]
        </div>
        <div class="divider"></div>
      `;
    }).join("");

    details.innerHTML = `
      <summary>
        ${day}
        <span class="day-delete" onclick="deleteEntireDay('${day.replace(/'/g, "\\'")}'); event.stopPropagation();"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" v[...]
      </summary>
      ${entriesHTML}
    `;

    container.appendChild(details);
  });
}

const container = document.getElementById(CONTAINER_ID);
const deleteRangeSel = document.getElementById(DELETE_RANGE_SELECT_ID);
const exportBtn = document.getElementById(EXPORT_BUTTON_ID);

document.addEventListener("history-updated", render);
render();

deleteRangeSel.addEventListener("change", () => {
  if (!deleteRangeSel.value) return;
  deleteRange(deleteRangeSel.value);
  deleteRangeSel.value = "";
});

exportBtn.addEventListener("click", exportLifetimeHistory);

// Also listen to storage events dynamically (works for both global and per-user storage keys)
window.addEventListener('storage', (e) => {
  if (!e.key) return;
  const k = getStorageKey();
  if (e.key === k || e.key === k + ':sync') {
    document.dispatchEvent(PAGE_EVENT);
  }
});
  </script>
</body>
</html>
