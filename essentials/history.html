<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lifetime Search History — EchoSearch</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="canocial" href="https://echo-search.github.io/essentials/history.html" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #fafafa;
    }

    h1 {
      margin-bottom: 15px;
    }

    .day-block {
      margin-bottom: 25px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    .day-block h2 {
      margin-top: 0;
      font-size: 1.3rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
      margin-bottom: 10px;
    }

    ul {
      margin: 0;
      padding-left: 20px;
    }

    li {
      margin-bottom: 6px;
    }

    .toolbar {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button, select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #888;
      cursor: pointer;
      background: white;
    }
  </style>
</head>

<body>
  <h1>Lifetime Search History</h1>

  <div class="toolbar">
    <select id="deleteRange">
      <option value="">Delete by range…</option>
      <option value="24h">Last 24 hours</option>
      <option value="7d">Last 7 days</option>
      <option value="30d">Last 30 days</option>
      <option value="365d">Last 365 days</option>
    </select>

    <button id="exportBtn">Export JSON</button>
  </div>

  <div id="lifetime"></div>

  <script>
    const PAGE_EVENT = new Event("history-updated");

    function saveSearch(query) {
      if (!query.trim()) return;
      const entry = { query, time: Date.now() };

      const home = JSON.parse(localStorage.getItem("searchHistory") || "[]");
      home.unshift(entry);
      localStorage.setItem("searchHistory", JSON.stringify(home));

      const life = JSON.parse(localStorage.getItem("lifetimeHistory") || "[]");
      life.unshift(entry);
      localStorage.setItem("lifetimeHistory", JSON.stringify(life));

      document.dispatchEvent(PAGE_EVENT);
    }

    function clearHomeHistory() {
      localStorage.setItem("searchHistory", "[]");
      document.dispatchEvent(PAGE_EVENT);
    }

    function formatDateHeader(dateObj) {
      const d = dateObj.getDate();
      const suffix =
        d % 10 === 1 && d !== 11 ? "st" :
        d % 10 === 2 && d !== 12 ? "nd" :
        d % 10 === 3 && d !== 13 ? "rd" : "th";

      return dateObj.toLocaleDateString("en-UK", {
        weekday: "long",
        month: "long",
        day: "numeric"
      }).replace(/\d+/, `${d}${suffix}`);
    }

    function getLifetimeGrouped() {
      const life = JSON.parse(localStorage.getItem("lifetimeHistory") || "[]");
      const groups = {};

      life.forEach(e => {
        const d = new Date(e.time);
        const header = formatDateHeader(d);
        if (!groups[header]) groups[header] = [];
        groups[header].push(e);
      });

      return groups;
    }

    function deleteRange(range) {
      const now = Date.now();

      const ranges = {
        "24h": now - 24 * 60 * 60 * 1000,
        "7d": now - 7 * 24 * 60 * 60 * 1000,
        "30d": now - 30 * 24 * 60 * 60 * 1000,
        "365d": now - 365 * 24 * 60 * 60 * 1000
      };

      if (!ranges[range]) return;

      const life = JSON.parse(localStorage.getItem("lifetimeHistory") || "[]");
      const filtered = life.filter(e => e.time < ranges[range]);

      localStorage.setItem("lifetimeHistory", JSON.stringify(filtered));
      document.dispatchEvent(PAGE_EVENT);
    }

    function exportLifetimeHistory() {
      const life = JSON.parse(localStorage.getItem("lifetimeHistory") || "[]");
      const blob = new Blob([JSON.stringify(life, null, 2)], {
        type: "application/json"
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "echo-lifetime-history.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // ---- Page Rendering ----
    const container = document.getElementById("lifetime");
    const deleteRangeSel = document.getElementById("deleteRange");
    const exportBtn = document.getElementById("exportBtn");

    function render() {
      const groups = getLifetimeGrouped();
      container.innerHTML = "";

      Object.keys(groups).forEach(day => {
        const block = document.createElement("div");
        block.className = "day-block";

        block.innerHTML = `
          <h2>${day}</h2>
          <ul>
            ${groups[day]
              .map(e => `<li>${e.query} — ${new Date(e.time).toLocaleTimeString()}</li>`)
              .join("")}
          </ul>
        `;

        container.appendChild(block);
      });
    }

    document.addEventListener("history-updated", render);

    render();

    deleteRangeSel.addEventListener("change", () => {
      if (!deleteRangeSel.value) return;
      deleteRange(deleteRangeSel.value);
      deleteRangeSel.value = "";
    });

    exportBtn.addEventListener("click", exportLifetimeHistory);
  </script>
</body>
</html>
