<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chess vs Bot</title>

<!-- Board library (super reliable) -->
<script src="https://unpkg.com/chessboard-element@1.4.0/dist/chessboard-element.js"></script>

<!-- Chess engine -->
<script src="https://cdn.jsdelivr.net/npm/stockfish/stockfish.wasm.js"></script>

<!-- Chess logic -->
<script type="module" src="https://unpkg.com/chess.mjs@1.4.0/dist/chess.mjs"></script>

<style>
  body { display: flex; flex-direction: column; align-items: center; font-family: sans-serif; }
  #board { width: 480px; margin-top: 20px; }
  #status { margin-top: 10px; font-size: 18px; }
  #score { margin-top: 5px; font-size: 16px; }
</style>
</head>
<body>

<h2>Play Chess vs Bot</h2>

<chess-board id="board" draggable-pieces></chess-board>

<div id="status">Game in progress</div>
<div id="score">White: 39 | Black: 39</div>

<script type="module">
import { Chess } from "https://unpkg.com/chess.mjs@1.4.0/dist/chess.mjs";

const game = new Chess();
const board = document.getElementById("board");
const bot = STOCKFISH();

const values = { p:1, n:3, b:3, r:5, q:9, k:0 };

bot.postMessage("uci");

// ---- SCORE CALC ----
function score() {
  let w = 0, b = 0;
  for (const row of game.board()) {
    for (const piece of row) {
      if (!piece) continue;
      const val = values[piece.type];
      if (piece.color === "w") w += val; else b += val;
    }
  }
  return { w, b };
}

// ---- UI update ----
function updateUI() {
  const s = score();
  document.getElementById("score").innerText = `White: ${s.w} | Black: ${s.b}`;

  let msg = "";
  if (game.isCheckmate()) msg = "Checkmate!";
  else if (game.isStalemate()) msg = "Stalemate!";
  else if (game.isCheck()) msg = "Check!";
  else msg = `Turn: ${game.turn() === "w" ? "White" : "Black"}`;

  document.getElementById("status").innerText = msg;
}

// ---- Human move ----
board.addEventListener("piece-drop", (e) => {
  const move = game.move({ from: e.detail.sourceSquare, to: e.detail.square, promotion: "q" });

  if (!move) {
    board.setPosition(game.fen());
    return e.preventDefault();
  }

  updateUI();
  setTimeout(botMove, 300);
});

// ---- Bot move ----
function botMove() {
  bot.postMessage(`position fen ${game.fen()}`);
  bot.postMessage("go depth 6"); // EASY-BUT-SMART

  bot.onmessage = (e) => {
    const line = (e.data + "");
    if (line.startsWith("bestmove")) {
      const best = line.split(" ")[1];
      if (best === "(none)") return;

      game.move({ 
        from: best.slice(0,2), 
        to: best.slice(2,4), 
        promotion: "q"
      });

      board.setPosition(game.fen());
      updateUI();
    }
  };
}

board.setPosition("start");
updateUI();
</script>
</body>
</html>
