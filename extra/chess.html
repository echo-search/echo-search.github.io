<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chess vs Real Bot</title>

<!-- Board library (NOT chessboard.js) -->
<script type="module" src="https://cdn.jsdelivr.net/npm/cm-chessboard@8.4.4/src/cm-chessboard.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cm-chessboard@8.4.4/assets/styles/cm-chessboard.css">

<!-- Stockfish engine (NOT chess.js) -->
<script src="https://cdn.jsdelivr.net/npm/stockfish/stockfish.wasm.js"></script>

<style>
  body { display: flex; flex-direction: column; align-items: center; font-family: sans-serif; }
  #board { width: 480px; height: 480px; margin-top: 20px; }
  #status { margin-top: 10px; font-size: 18px; }
  #score { margin-top: 5px; font-size: 16px; }
</style>
</head>
<body>

<h2>Play Chess vs Bot</h2>
<div id="board"></div>
<div id="status">Game in progress</div>
<div id="score">White: 39 | Black: 39</div>

<script type="module">
import { Chess } from "https://cdn.jsdelivr.net/npm/chess.mjs@1.2.0/+esm";
import { Chessboard } from "https://cdn.jsdelivr.net/npm/cm-chessboard@8.4.4/src/cm-chessboard.js";

const game = new Chess();
const pieceValues = { p:1, n:3, b:3, r:5, q:9, k:0 };

// Create board
const board = new Chessboard(document.getElementById("board"), {
    position: "start",
    movable: {
        free: false,
        color: "white",
        events: {
            after: (from, to) => onPlayerMove(from, to)
        }
    }
});

// Stockfish bot
const bot = STOCKFISH();
bot.postMessage("uci");

// Calculate material points
function calculateScore() {
    let white = 0, black = 0;
    for (const row of game.board()) {
        for (const piece of row) {
            if (!piece) continue;
            const v = pieceValues[piece.type];
            if (piece.color === "w") white += v;
            else black += v;
        }
    }
    return { white, black };
}

function updateUI() {
    // Score
    const score = calculateScore();
    document.getElementById("score").innerText =
        `White: ${score.white} | Black: ${score.black}`;

    // Status
    let msg = "";
    if (game.isCheckmate()) msg = "Checkmate!";
    else if (game.isStalemate()) msg = "Stalemate!";
    else if (game.isCheck()) msg = "Check!";
    else msg = `Turn: ${game.turn() === "w" ? "White" : "Black"}`;

    document.getElementById("status").innerText = msg;
}

// After human moves
function onPlayerMove(from, to) {
    const legal = game.move({ from, to, promotion: "q" });
    if (!legal) {
        board.setPosition(game.fen());
        return;
    }

    updateUI();
    setTimeout(botMove, 200);
}

// Bot plays using Stockfish
function botMove() {
    bot.postMessage(`position fen ${game.fen()}`);
    bot.postMessage("go depth 8");

    bot.onmessage = (e) => {
        const line = e.data + "";
        if (line.startsWith("bestmove")) {
            const move = line.split(" ")[1];
            if (move === "(none)") return;

            game.move({ from: move.slice(0,2), to: move.slice(2,4), promotion:"q" });
            board.setPosition(game.fen());
            updateUI();
        }
    };
}

updateUI();
</script>

</body>
</html>
