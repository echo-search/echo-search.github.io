<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quran App — Single File</title>
<style>
  :root{
    --bg:#f7f7f7; --panel:#fff; --muted:#666; --accent:#2b6cb0;
    --glass: rgba(255,255,255,0.6);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --panel:#071021; --muted:#9aa9bf; --accent:#6fb3ff; --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:#111}
  .app{max-width:1100px;margin:18px auto;padding:14px;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#8dd3ff);display:grid;place-items:center;color:white;font-weight:700}
  .controls{display:flex;gap:8px;align-items:center}
  button,select{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:var(--panel);cursor:pointer}
  input[type="range"]{width:120px}
  main{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:14px}
  .reader{background:var(--panel);padding:14px;border-radius:12px;min-height:60vh;position:relative}
  .toolbar{display:flex;gap:6px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .surah-meta{display:flex;gap:12px;align-items:center;margin-bottom:10px}
  .ayah{padding:8px;border-radius:8px;margin:6px 0;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.01));display:flex;gap:12px;align-items:flex-start}
  .ayah .num{width:36px;height:36;border-radius:50%;display:grid;place-items:center;background:var(--glass);font-weight:600;color:var(--muted)}
  .arabic{font-size:28px;line-height:1.6;direction:rtl;flex:1}
  .trans{font-size:14px;color:var(--muted);margin-top:6px}
  .side{background:var(--panel);padding:14px;border-radius:12px;min-height:60vh;overflow:auto}
  .feature{margin-bottom:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.02))}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  .small{font-size:12px;color:var(--muted)}
  .btn-ghost{background:transparent;border:1px dashed rgba(0,0,0,0.06)}
  .highlight{border:2px solid rgba(107,156,255,0.18);box-shadow:0 6px 24px rgba(43,108,176,0.06)}
  .shadow-hidden{color:transparent;text-shadow:0 0 8px rgba(0,0,0,0.25);transition:all .3s}
  .whisper-overlay{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none;border-radius:12px;mix-blend-mode:multiply}
  .map {width:100%;height:220px;border-radius:8px;overflow:hidden;background:linear-gradient(180deg,#e3f2fd,#fff)}
  .timeline{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .event{padding:8px;border-radius:8px;background:var(--glass);cursor:pointer}
  .progress{height:8px;background:rgba(0,0,0,0.06);border-radius:8px;margin-top:10px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7fd1ff);width:0%}
  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
  @media(max-width:900px){main{grid-template-columns:1fr} .side{order:2}}
</style>
</head>
<body>
<div class="app" id="app" data-theme="light">
  <header>
    <div class="brand">
      <div class="logo">ق</div>
      <div>
        <div style="font-weight:700">Quran Mini — Single File</div>
        <div class="small">Sample data included. Replace with full content for production.</div>
      </div>
    </div>

    <div class="controls">
      <select id="surahSelect" title="Choose surah"></select>
      <input id="searchInput" placeholder="Search (arabic/translation)" />
      <button id="searchBtn">Search</button>
      <button id="bookmarkBtn">Bookmarks</button>
      <button id="themeBtn">Dark</button>
      <div style="display:flex;align-items:center;gap:8px">
        <label class="small">Font</label>
        <input id="fontRange" type="range" min="16" max="42" value="28" />
      </div>
    </div>
  </header>

  <main>
    <section class="reader" id="reader">
      <div class="toolbar">
        <div class="surah-meta">
          <div id="surahTitle" style="font-weight:700"></div>
          <div class="small" id="surahInfo"></div>
        </div>

        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="playBtn">▶ Play</button>
          <button id="pauseBtn">⏸</button>
          <button id="emotionToggle">Emotion Mode</button>
          <button id="memorizeToggle">Memorize Mode</button>
          <button id="whisperToggle">Whisper Night</button>
        </div>
      </div>

      <div id="ayahContainer"></div>

      <div id="whisperOverlay" class="whisper-overlay" style="opacity:0"></div>

      <div class="progress" title="Reading progress">
        <i id="readProgress"></i>
      </div>
    </section>

    <aside class="side">
      <div class="feature">
        <label>Audio / Listen</label>
        <div class="small">Plays Arabic TTS (if Arabic voice available) or translation voice.</div>
        <select id="audioVoiceSelect"></select>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="playRecite">Recite Ayah</button>
          <button id="playTrans">Read Translation</button>
        </div>
      </div>

      <div class="feature">
        <label>Emotion-Linked Recitation Mode</label>
        <div class="small">Pick how you feel and get highlighted ayahs curated for that mood.</div>
        <select id="emotionSelect">
          <option value="">— choose emotion —</option>
          <option value="calm">Calm / Peaceful</option>
          <option value="stressed">Stressed / Distressed</option>
          <option value="grateful">Grateful</option>
          <option value="fear">Fear / Uneasy</option>
          <option value="hope">Hopeful</option>
        </select>
        <button id="applyEmotion">Apply</button>
      </div>

      <div class="feature">
        <label>Mistake-Proof Memorisation Shadows</label>
        <div class="small">Cycle hides more of the ayah each time. Use during memorization sessions.</div>
        <div style="display:flex;gap:6px;align-items:center">
          <label class="small">Start with hide %</label>
          <input id="startHide" type="number" min="0" max="90" value="20" style="width:60px" />
          <label class="small">Cycle count</label>
          <input id="cycles" type="number" min="1" max="6" value="4" style="width:60px" />
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="memorizeStart">Start Session</button>
          <button id="memorizeNext">Next Cycle</button>
          <button id="memorizeReset">Reset</button>
        </div>
      </div>

      <div class="feature">
        <label>Historical Revelation Map (Hijrah Route Edition)</label>
        <div class="map" id="mapSVG">
          <svg viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet" style="width:100%;height:100%">
            <rect width="100%" height="100%" fill="url(#g)"></rect>
            <defs>
              <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#e3f2fd"/>
                <stop offset="1" stop-color="#fff"/>
              </linearGradient>
            </defs>
            <path id="route" d="M80 220 C200 150 400 120 720 70" stroke="#c63" stroke-width="3" fill="none" stroke-linecap="round"></path>
            <g id="markers"></g>
          </svg>
        </div>

        <div class="timeline" id="timeline"></div>
        <div class="small" style="margin-top:8px">Click event to jump to the ayah in the reader.</div>
      </div>

      <div class="feature">
        <label>Extras / Utilities</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="toggleTrans">Toggle Translation</button>
          <button id="toggleArabic">Toggle Arabic</button>
          <button id="exportBookmarks">Export Bookmarks</button>
        </div>
      </div>

    </aside>
  </main>

  <footer>Single-file Quran app — demo data included. Replace `DATA` block with full dataset for production.</footer>
</div>

<script>
const DATA = { surahs: [], emotionIndex: {
  calm: [{surah:1,ayah:1},{surah:1,ayah:3},{surah:112,ayah:2}],
  stressed: [{surah:1,ayah:2},{surah:1,ayah:6}],
  grateful: [{surah:1,ayah:2},{surah:112,ayah:2}],
  fear: [{surah:1,ayah:4},{surah:1,ayah:5}],
  hope: [{surah:1,ayah:6},{surah:112,ayah:4}]
}};

const REMOTE_URL = 'https://cdn.jsdelivr.net/npm/quran-json@3.1.2/dist/quran.json';

const state = {
  currentSurah: 1,
  showTranslation: true,
  showArabic: true,
  fontSize: 28,
  bookmarks: JSON.parse(localStorage.getItem('qbook')||'[]'),
  memorize: {active:false, cycle:0, cycles:4, startHide:20},
  whisper: {active:false, dimInterval:null, dimLevel:0},
  emotion: null
};

const surahSelect = document.getElementById('surahSelect');
const ayahContainer = document.getElementById('ayahContainer');
const surahTitle = document.getElementById('surahTitle');
const surahInfo = document.getElementById('surahInfo');
const fontRange = document.getElementById('fontRange');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const themeBtn = document.getElementById('themeBtn');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const audioVoiceSelect = document.getElementById('audioVoiceSelect');
const playRecite = document.getElementById('playRecite');
const playTrans = document.getElementById('playTrans');
const emotionSelect = document.getElementById('emotionSelect');
const applyEmotion = document.getElementById('applyEmotion');
const memorizeStart = document.getElementById('memorizeStart');
const memorizeNext = document.getElementById('memorizeNext');
const memorizeReset = document.getElementById('memorizeReset');
const startHide = document.getElementById('startHide');
const cyclesInput = document.getElementById('cycles');
const memorizeToggle = document.getElementById('memorizeToggle');
const emotionToggle = document.getElementById('emotionToggle');
const whisperToggle = document.getElementById('whisperToggle');
const whisperOverlay = document.getElementById('whisperOverlay');
const toggleTrans = document.getElementById('toggleTrans');
const toggleArabic = document.getElementById('toggleArabic');
const exportBookmarks = document.getElementById('exportBookmarks');
const readProgress = document.getElementById('readProgress');
const timeline = document.getElementById('timeline');
const markersGroup = document.getElementById('markers');

let qariAudioQueue = null;

async function loadRemoteData(){
  try{
    const res = await fetch(REMOTE_URL);
    if(!res.ok) throw new Error('Failed to fetch remote quran JSON');
    const json = await res.json();

    if(Array.isArray(json) && json.length){
      const mapped = json.map(s => {
        const verses = (s.verses || s.ayahs || s.ayahs_list || s.ayah_list || []).map(v => {
          return {
            num: v.number || v.verse || v.ayah || (v.index? v.index+1: undefined),
            text: v.text || v.arabic_text || v.ar || v.q || '',
            trans: (v.translation && (v.translation.en || v.translation.en_US)) || v.translationText || v.en || v.trans || (v.translation_english) || ''
          };
        });
        return {
          num: s.number || s.chapter || s.id || s.idx || 0,
          name: s.name || s.arabicName || s.ar_name || s.simpleName || s.surah || s.englishName || '',
          english: s.englishName || s.translation || s.english_name || s.name_simple || s.english || '',
          ayahs: verses.length ? verses : []
        };
      });
      DATA.surahs = mapped.filter(s=>s.num && s.ayahs && s.ayahs.length);
    } else if(json.surahs && Array.isArray(json.surahs)){
      const mapped = json.surahs.map(s => {
        const verses = (s.verses || []).map(v=>({
          num: v.numberInSurah || v.number || v.verse || v.ayah,
          text: v.text || v.arabic || '',
          trans: v.translation || v.trans || ''
        }));
        return { num: s.number || s.id, name: s.name || s.englishName || s.translationName || s.simpleName || '', english: s.englishName || '', ayahs: verses };
      });
      DATA.surahs = mapped.filter(s=>s.num && s.ayahs && s.ayahs.length);
    } else {
      console.warn('Unexpected remote json shape, falling back to sample dataset');
    }
  }catch(e){
    console.warn('Load remote failed:', e);
  }

  if(!DATA.surahs.length){
    DATA.surahs = [
      {num:1, name:'Al-Fātiḥah', english:'The Opening', ayahs:[
        {num:1, text:'بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ', trans:'In the name of Allah, the Entirely Merciful, the Especially Merciful.'},
        {num:2, text:'الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ', trans:'[All] praise is [due] to Allah, Lord of the worlds —'},
        {num:3, text:'الرَّحْمَٰنِ الرَّحِيمِ', trans:'The Entirely Merciful, the Especially Merciful,'},
        {num:4, text:'مَالِكِ يَوْمِ الدِّينِ', trans:'Sovereign of the Day of Recompense.'},
        {num:5, text:'إِيَّاكَ نَعْبُدُ وَإِيَّاكَ نَسْتَعِينُ', trans:'It is You we worship and You we ask for help.'},
        {num:6, text:'اهْدِنَا الصِّرَاطَ الْمُسْتَقِيمَ', trans:'Guide us to the straight path —'},
        {num:7, text:'صِرَاطَ الَّذِينَ أَنْعَمْتَ عَلَيْهِمْ', trans:'The path of those upon whom You have bestowed favor,'}
      ]},
      {num:112,name:'Al-Ikhlāṣ',english:'Sincerity', ayahs:[
        {num:1,text:'قُلْ هُوَ اللَّهُ أَحَدٌ',trans:'Say, "He is Allah, [who is] One,"'},
        {num:2,text:'اللَّهُ الصَّمَدُ',trans:'Allah, the Eternal Refuge.'},
        {num:3,text:'لَمْ يَلِدْ وَلَمْ يُولَدْ',trans:'He neither begets nor is born,'},
        {num:4,text:'وَلَمْ يَكُنْ لَهُ كُفُوًا أَحَدٌ',trans:'Nor is there to Him any equivalent."'}
      ]}
    ];
  }
  state.currentSurah = DATA.surahs[0].num;
}

async function init(){
  await loadRemoteData();

  DATA.emotionIndex = DATA.emotionIndex || {
    calm: [{surah:1,ayah:1},{surah:1,ayah:3},{surah:112,ayah:2}],
    stressed: [{surah:1,ayah:2},{surah:1,ayah:6}],
    grateful: [{surah:1,ayah:2},{surah:112,ayah:2}],
    fear: [{surah:1,ayah:4},{surah:1,ayah:5}],
    hope: [{surah:1,ayah:6},{surah:112,ayah:4}]
  };

  DATA.surahs.forEach(s=>{
    const o = document.createElement('option'); o.value = s.num; o.textContent = `${s.num}. ${s.name} — ${s.english || ''}`;
    surahSelect.appendChild(o);
  });
  surahSelect.value = state.currentSurah;

  setTimeout(populateVoices, 200);
  if (speechSynthesis) speechSynthesis.onvoiceschanged = populateVoices;

  fontRange.value = state.fontSize;
  fontRange.addEventListener('input', e=>{
    state.fontSize = +e.target.value;
    document.querySelectorAll('.arabic').forEach(n=>n.style.fontSize = state.fontSize+'px');
  });

  surahSelect.addEventListener('change', e=>{
    state.currentSurah = +e.target.value; renderSurah(); renderMap();
  });

  searchBtn.addEventListener('click', doSearch);
  document.getElementById('bookmarkBtn').addEventListener('click', showBookmarks);
  themeBtn.addEventListener('click', toggleTheme);

  playBtn.addEventListener('click', ()=>playAllArabic());
  pauseBtn.addEventListener('click', ()=>{ if(qariAudioQueue && qariAudioQueue.stop) qariAudioQueue.stop(); if('speechSynthesis' in window) speechSynthesis.cancel(); });

  playRecite.addEventListener('click',()=>playSelectedRecitation());
  playTrans.addEventListener('click',()=>playSelectedTranslation());

  emotionToggle.addEventListener('click', ()=>{ document.getElementById('app').scrollIntoView({behavior:'smooth'}); flash(emotionSelect); });
  memorizeToggle.addEventListener('click', ()=>{ document.getElementById('app').scrollIntoView({behavior:'smooth'}); flash(startHide); });

  applyEmotion.addEventListener('click', applyEmotionMode);

  memorizeStart.addEventListener('click', startMemorizeSession);
  memorizeNext.addEventListener('click', memorizeNextCycle);
  memorizeReset.addEventListener('click', resetMemorizeSession);

  toggleTrans.addEventListener('click', ()=>{ state.showTranslation = !state.showTranslation; renderSurah(); });
  toggleArabic.addEventListener('click', ()=>{ state.showArabic = !state.showArabic; renderSurah(); });
  exportBookmarks.addEventListener('click', exportBook);

  whisperToggle.addEventListener('click', toggleWhisperMode);

  renderMap();
  renderSurah();
  updateProgress();
}
init();

function getSurah(num){ return DATA.surahs.find(s=>s.num===num) || DATA.surahs[0]; }

function renderSurah(){
  const s = getSurah(state.currentSurah);
  surahTitle.textContent = `${s.num}. ${s.name}`;
  surahInfo.textContent = (s.english || '') + ' — ' + (s.ayahs.length || 0) + ' ayahs';
  ayahContainer.innerHTML = '';
  (s.ayahs || []).forEach(a=>{
    const node = document.createElement('div'); node.className='ayah';
    const numNode = document.createElement('div'); numNode.className='num'; numNode.textContent = a.num;
    const content = document.createElement('div'); content.style.flex='1';
    const arab = document.createElement('div'); arab.className='arabic'; arab.style.fontSize = state.fontSize+'px'; arab.textContent = a.text || a.arabic || '';
    const trans = document.createElement('div'); trans.className='trans'; trans.textContent = a.trans || a.translation || '';
    node.dataset.surah = s.num; node.dataset.ayah = a.num;
    content.appendChild(arab);
    if(state.showTranslation) content.appendChild(trans);
    if(!state.showArabic){ arab.style.display='none' } else arab.style.display='';
    node.appendChild(numNode); node.appendChild(content);
    node.addEventListener('click', ()=>selectAyah(node));
    addLongPress(node,()=>startBreathing(8));
    ayahContainer.appendChild(node);
  });
  applyEmotionHighlights();
  updateProgress();
}

function doSearch(){
  const q = (searchInput.value||'').trim().toLowerCase();
  if(!q){ renderSurah(); return; }
  const results = [];
  DATA.surahList = DATA.surahList || DATA.surahs.reduce((acc,s)=>{ (s.ayahs||[]).forEach(a=>acc.push({surah:s.num,surahName:s.name,ayah:a})); return acc; },[]);
  DATA.surahList.forEach(item=>{
    if((item.ayah.text||'').toLowerCase().includes(q) || ((item.ayah.trans||'').toLowerCase().includes(q)) || (item.surahName||'').toLowerCase().includes(q)){
      results.push(item);
    }
  });
  ayahContainer.innerHTML='';
  if(!results.length){ ayahContainer.innerHTML = '<div class="small">No results in data.</div>'; return; }
  results.forEach(r=>{
    const node = document.createElement('div'); node.className='ayah';
    const numNode = document.createElement('div'); numNode.className='num'; numNode.textContent = r.ayah.num + ' • ' + r.surah;
    const content = document.createElement('div'); content.style.flex='1';
    const arab = document.createElement('div'); arab.className='arabic'; arab.style.fontSize = state.fontSize+'px'; arab.textContent = r.ayah.text || '';
    const trans = document.createElement('div'); trans.className='trans'; trans.textContent = r.ayah.trans || '';
    content.appendChild(arab); if(state.showTranslation) content.appendChild(trans);
    node.appendChild(numNode); node.appendChild(content);
    ayahContainer.appendChild(node);
  });
}

function selectAyah(node){
  const surah = +node.dataset.surah, ayah = +node.dataset.ayah;
  const key = `${surah}:${ayah}`;
  const idx = state.bookmarks.indexOf(key);
  if(idx===-1){
    state.bookmarks.push(key);
    localStorage.setItem('qbook', JSON.stringify(state.bookmarks));
    flash(node);
  } else {
    state.bookmarks.splice(idx,1);
    localStorage.setItem('qbook', JSON.stringify(state.bookmarks));
    node.classList.remove('highlight');
  }
  renderSurah();
}

function showBookmarks(){
  if(!state.bookmarks.length){
    alert('No bookmarks yet. Click an ayah to bookmark it.');
    return;
  }
  const list = state.bookmarks.map(b=>{
    const [s,a] = b.split(':');
    const sur = getSurah(+s);
    const ay = (sur && sur.ayahs) ? sur.ayahs.find(x=>x.num==+a) : null;
    return `${s}•${sur ? sur.name : '(surah)'} — ${a}: ${ay ? ay.trans || ay.text : '(missing)'}`;
  }).join('\n\n');
  prompt('Bookmarks (copy):', list);
}

function exportBook(){
  const data = {bookmarks:state.bookmarks, exportedAt:new Date().toISOString()};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='qbookmarks.json'; a.click();
  URL.revokeObjectURL(url);
}

function populateVoices(){
  audioVoiceSelect.innerHTML = '';
  if(!('speechSynthesis' in window)) { audioVoiceSelect.innerHTML = '<option>No TTS</option>'; return; }
  const v = speechSynthesis.getVoices();
  v.forEach((voice,i)=>{
    const o = document.createElement('option'); o.value=i; o.textContent = voice.name + ' — ' + voice.lang;
    audioVoiceSelect.appendChild(o);
  });
  if(!v.length) audioVoiceSelect.innerHTML = '<option>No TTS voices found in this browser</option>';
}

function speak(text, lang){
  if(!('speechSynthesis' in window)){ alert('No speech synthesis available'); return; }
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  const idx = audioVoiceSelect.value;
  const voices = speechSynthesis.getVoices();
  if(voices && voices.length && voices[idx]) u.voice = voices[idx];
  if(lang) u.lang = lang;
  speechSynthesis.speak(u);
}

function stopQariQueue(){
  if(qariAudioQueue && qariAudioQueue.stop) qariAudioQueue.stop();
  qariAudioQueue = null;
}

function playAllArabic(){
  stopQariQueue();
  const s = getSurah(state.currentSurah);
  const verses = (s.ayahs||[]).slice();
  if(!verses.length) return;
  const base = 'https://cdn.islamic.network/quran/audio/128/ar.alafasy/';
  let index = 0;
  let currentAudio = null;

  const queue = {
    stopped:false,
    stop(){
      this.stopped = true;
      if(currentAudio){ currentAudio.pause(); currentAudio.src=''; currentAudio = null; }
    }
  };
  qariAudioQueue = queue;

  function playNext(){
    if(queue.stopped) return;
    if(index >= verses.length) return;
    const sur = String(s.num).padStart(3,'0');
    const ay = String(verses[index].num).padStart(3,'0');
    const url = `${base}${sur}${ay}.mp3`;
    currentAudio = new Audio(url);
    currentAudio.crossOrigin = 'anonymous';
    currentAudio.onended = ()=>{ index++; playNext(); };
    currentAudio.onerror = ()=>{ index++; playNext(); };
    currentAudio.play().catch(()=>{ /* user interaction required or blocked */ });
  }
  playNext();
}

function playSingleAyahAudio(surahNum, ayahNum){
  stopQariQueue();
  const base = 'https://cdn.islamic.network/quran/audio/128/ar.alafasy/';
  const sur = String(surahNum).padStart(3,'0');
  const ay = String(ayahNum).padStart(3,'0');
  const audio = new Audio(`${base}${sur}${ay}.mp3`);
  audio.crossOrigin = 'anonymous';
  audio.play().catch(()=>{});
}

function playSelectedRecitation(){
  if(lastClickedNode){
    const sur = +lastClickedNode.dataset.surah; const ay = +lastClickedNode.dataset.ayah;
    playSingleAyahAudio(sur, ay);
  } else playAllArabic();
}

function playSelectedTranslation(){
  stopQariQueue();
  if(lastClickedNode){
    const sur = +lastClickedNode.dataset.surah; const ay = +lastClickedNode.dataset.ayah;
    const s = getSurah(sur);
    const a = (s.ayahs || []).find(x=>x.num==ay);
    if(a) speak(a.trans || a.translation || a.text, 'en-US');
  } else {
    const s = getSurah(state.currentSurah);
    speak((s.ayahs || []).map(x=>x.trans || x.translation || '').join(' '),'en-US');
  }
}

function applyEmotionMode(){
  const emot = emotionSelect.value;
  state.emotion = emot || null;
  applyEmotionHighlights();
  if(state.emotion){
    const idx = DATA.emotionIndex[state.emotion] && DATA.emotionIndex[state.emotion][0];
    if(idx){
      state.currentSurah = idx.surah; surahSelect.value = state.currentSurah; renderSurah();
      setTimeout(()=> {
        const nodes = [...ayahContainer.children];
        const n = nodes.find(nd=>+nd.dataset.ayah===idx.ayah && +nd.dataset.surah===idx.surah);
        if(n){ n.scrollIntoView({behavior:'smooth',block:'center'}); flash(n); }
      },200);
    }
  }
}

function applyEmotionHighlights(){
  document.querySelectorAll('.ayah').forEach(n=>n.classList.remove('highlight'));
  if(!state.emotion) return;
  const list = DATA.emotionIndex[state.emotion] || [];
  list.forEach(m=>{
    if(+m.surah !== state.currentSurah) return;
    const node = [...ayahContainer.children].find(nd=>+nd.dataset.ayah===+m.ayah && +nd.dataset.surah===+m.surah);
    if(node) node.classList.add('highlight');
  });
}

function startMemorizeSession(){
  state.memorize.active = true;
  state.memorize.cycles = +cyclesInput.value || 4;
  state.memorize.cycle = 0;
  state.memorize.startHide = (+startHide.value) || 20;
  memorizeNextCycle();
}
function memorizeNextCycle(){
  if(!state.memorize.active) return alert('Start a session first');
  state.memorize.cycle++;
  const pct = Math.min(90, state.memorize.startHide + (state.memorize.cycle-1) * Math.round((100-state.memorize.startHide)/(state.memorize.cycles)));
  [...ayahContainer.querySelectorAll('.ayah')].forEach(node=>{
    const arab = node.querySelector('.arabic');
    const txt = arab.textContent || '';
    const words = txt.split(/\s+/);
    const hideCount = Math.floor(words.length * (pct/100));
    const newWords = words.map((w,i)=>{
      const seed = (i + state.memorize.cycle) % words.length;
      if(seed < hideCount) return '_'.repeat(Math.min(6,w.length));
      return w;
    });
    arab.textContent = newWords.join(' ');
    arab.classList.add('shadow-hidden');
    arab.style.textShadow = 'none';
  });
  if(state.memorize.cycle >= state.memorize.cycles){
    alert('Final cycle reached. Use Reset to restore full text.');
  } else {
    flash(memorizeNext);
  }
}
function resetMemorizeSession(){
  state.memorize.active = false;
  state.memorize.cycle = 0;
  renderSurah();
}

function renderMap(){
  markersGroup.innerHTML='';
  timeline.innerHTML='';
  const events = [];
  DATA.surahs.forEach(sur=>{
    (sur.ayahs||[]).forEach(a=>{
      if(a.coords) events.push({surah:sur.num, name:sur.name, ayah:a.num, trans:a.trans, coords:a.coords, rev:a.revelation});
    });
  });
  events.forEach(ev=>{
    if(!ev.coords) return;
    const [cx,cy] = ev.coords;
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx', cx); circle.setAttribute('cy', cy); circle.setAttribute('r',6);
    circle.setAttribute('fill', ev.rev==='makkah' ? '#2b6cb0' : '#c63');
    circle.style.cursor='pointer';
    circle.addEventListener('click', ()=>{ jumpToAyah(ev.surah, ev.ayah); });
    markersGroup.appendChild(circle);
    const div = document.createElement('div'); div.className='event'; div.textContent = `${ev.surah}:${ev.ayah} — ${ev.name}`;
    div.addEventListener('click', ()=>{ jumpToAyah(ev.surah, ev.ayah); });
    timeline.appendChild(div);
  });
}

function jumpToAyah(surah, ayah){
  state.currentSurah = +surah; surahSelect.value = state.currentSurah; renderSurah();
  setTimeout(()=> {
    const nodes = [...ayahContainer.children];
    const n = nodes.find(nd=>+nd.dataset.ayah===+ayah && +nd.dataset.surah===+surah);
    if(n) n.scrollIntoView({behavior:'smooth',block:'center'});
    flash(n || ayahContainer);
  },200);
}

function toggleWhisperMode(){
  state.whisper.active = !state.whisper.active;
  if(state.whisper.active){
    whisperOverlay.style.transition='opacity 2s linear';
    whisperOverlay.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.05), rgba(0,0,0,0.25))';
    whisperOverlay.style.opacity = 0.28;
    let level = 0.28;
    state.whisper.dimInterval = setInterval(()=>{
      level = Math.min(0.6, level + 0.03);
      whisperOverlay.style.opacity = level;
      document.querySelectorAll('.arabic').forEach(n=>{
        const fs = parseFloat(n.style.fontSize || 28);
        n.style.fontSize = (Math.min(38, fs + 0.12))+'px';
      });
    }, 4000);
    document.addEventListener('click', tapSound);
  } else {
    whisperOverlay.style.opacity = 0;
    clearInterval(state.whisper.dimInterval);
    document.removeEventListener('click', tapSound);
    renderSurah();
  }
}
function tapSound(){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const o = ctx.createOscillator(); const g = ctx.createGain();
  o.type='sine'; o.frequency.value = 200; g.gain.value = 0.0025;
  o.connect(g); g.connect(ctx.destination);
  o.start(); o.stop(ctx.currentTime + 0.06);
}

let breathingTimer = null;
function startBreathing(seconds=6){
  const steps = seconds;
  let i=0;
  if(breathingTimer) clearInterval(breathingTimer);
  breathingTimer = setInterval(()=>{
    i++;
    const level = 0.12 + 0.12*Math.sin( (i/steps) * Math.PI * 2 );
    whisperOverlay.style.opacity = level;
    if(i>=steps) { clearInterval(breathingTimer); breathingTimer=null; whisperOverlay.style.opacity = state.whisper.active?0.28:0; }
  }, 1000);
}

function toggleTheme(){ const app=document.getElementById('app'); app.dataset.theme = app.dataset.theme==='light'?'dark':'light'; themeBtn.textContent = app.dataset.theme==='light'?'Dark':'Light'; }
function flash(node){ if(!node) return; node.animate([{transform:'scale(1)'},{transform:'scale(1.03)'},{transform:'scale(1)'}],{duration:320}); }
function updateProgress(){
  const s = getSurah(state.currentSurah);
  const total = s.ayahs.length || 0;
  const sc = document.querySelector('.reader').scrollTop || 0;
  const pct = Math.min(100, Math.round((sc/1000)*100));
  readProgress.style.width = pct+'%';
}

function addLongPress(node,fn,ms=600){
  let timer=null;
  node.addEventListener('pointerdown', (e)=>{ timer=setTimeout(()=>fn(), ms); });
  node.addEventListener('pointerup', ()=>{ clearTimeout(timer); timer=null; });
  node.addEventListener('pointerleave', ()=>{ clearTimeout(timer); timer=null; });
}

let lastClickedNode = null;
ayahContainer.addEventListener('click', (e)=>{
  const root = e.target.closest('.ayah');
  if(root) { lastClickedNode = root; }
});
ayahContainer.addEventListener('scroll', updateProgress);

function showConfirm(msg){ return confirm(msg); }
</script>
</body>
</html>
