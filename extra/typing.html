<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Touch Typing — Single File</title>
<style>
  :root{
    --bg:#f4f7fb; --panel:#fff; --muted:#6b7280; --accent:#2563eb; --danger:#dc2626; --success:#16a34a;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --panel:#07101a; --muted:#94a3b8; --accent:#60a5fa; --danger:#fb7185; --success:#4ade80;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:var(--muted); padding:18px;}
  .app{max-width:1000px;margin:10px auto; display:grid; gap:14px; grid-template-columns:1fr 360px;}
  header{grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; gap:12px}
  h1{margin:0;color:var(--accent); font-size:20px}
  .card{background:var(--panel); border-radius:10px; padding:14px; box-shadow:0 6px 20px rgba(2,6,23,0.06);}
  .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  select,input[type="number"]{padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08); background:transparent; color:inherit;}
  button{background:var(--accent); color:white;border:none;padding:8px 12px;border-radius:8px; cursor:pointer;}
  button.ghost{background:transparent;color:var(--accent); border:1px solid rgba(37,99,235,0.12)}
  .stats{display:flex; gap:12px; align-items:center; margin-top:8px}
  .stat{background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent); padding:8px 10px;border-radius:8px; min-width:90px; text-align:center;}
  .stat .num{display:block;font-weight:700;color:var(--accent); font-size:18px}
  .typing-area{min-height:160px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:18px; padding:14px; line-height:1.6; border-radius:8px; border:1px dashed rgba(0,0,0,0.06); background:linear-gradient(180deg,transparent, rgba(0,0,0,0.01))}
  .passage .char{padding:1px 2px; border-radius:3px}
  .char.correct{background:rgba(34,197,94,0.12); color:var(--accent)}
  .char.incorrect{background:rgba(220,38,38,0.08); color:var(--danger)}
  .char.next{outline:2px solid rgba(37,99,235,0.12)}
  .progress{height:8px; background:rgba(0,0,0,0.06); border-radius:999px; overflow:hidden; margin-top:8px}
  .progress > i{display:block;height:100%; background:var(--accent); width:0%}
  .keyboard{margin-top:12px; user-select:none}
  .row{display:flex; gap:6px; justify-content:center}
  .key{padding:10px 12px;border-radius:6px;background:rgba(0,0,0,0.03); min-width:36px; text-align:center; font-size:13px}
  .key.hint{background:linear-gradient(90deg, rgba(37,99,235,0.12), rgba(37,99,235,0.04)); border:1px solid rgba(37,99,235,0.08);}
  .settings{display:flex; flex-direction:column; gap:8px}
  .right-col{display:flex; flex-direction:column; gap:12px}
  .history{display:flex; flex-direction:column; gap:8px}
  .list{max-height:200px; overflow:auto; padding:6px; border-radius:8px; background:linear-gradient(180deg,transparent, rgba(0,0,0,0.02))}
  .mistakes{font-family:monospace; white-space:pre-wrap; color:var(--danger)}
  .small{font-size:13px;color:var(--muted)}
  .toggles{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label.switch{display:flex;align-items:center;gap:8px;}
  input[type="checkbox"]{transform:scale(1.1)}
  footer{grid-column:1/-1; text-align:center; font-size:13px; color:var(--muted)}
  @media (max-width:980px){ .app{grid-template-columns:1fr} .right-col{order:2} }
</style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>Touch Typing — Single File App</h1>
      <div class="small">Built for quick practice — no installs. Press <kbd>Enter</kbd> to start/pause.</div>
    </header>

    <section class="card">
      <div class="controls">
        <div>
          <label class="small">Lesson:</label>
          <select id="lessonSelect">
            <option value="home">Home row practice — easy</option>
            <option value="pangram">Pangram — common letters</option>
            <option value="advanced">Advanced passage — longer</option>
          </select>
        </div>

        <div>
          <label class="small">Mode:</label>
          <select id="modeSelect">
            <option value="time">Time (30s)</option>
            <option value="passage">Full passage</option>
          </select>
        </div>

        <div>
          <label class="small">Time (s):</label>
          <input id="timeInput" type="number" min="10" step="10" value="30" style="width:70px"/>
        </div>

        <div class="toggles">
          <label class="switch small"><input id="soundToggle" type="checkbox" checked/> Sound</label>
          <label class="switch small"><input id="darkToggle" type="checkbox"/> Dark</label>
        </div>

        <div style="margin-left:auto" class="controls">
          <button id="startBtn">Start</button>
          <button class="ghost" id="resetBtn">Reset</button>
        </div>
      </div>

      <div class="stats" style="margin-top:12px;">
        <div class="stat"><span class="small">Time</span><span id="timeDisplay" class="num">00:00</span></div>
        <div class="stat"><span class="small">WPM</span><span id="wpmDisplay" class="num">0</span></div>
        <div class="stat"><span class="small">Accuracy</span><span id="accDisplay" class="num">100%</span></div>
        <div class="stat"><span class="small">Typed</span><span id="typedDisplay" class="num">0</span></div>
      </div>

      <div class="typing-area card" id="typingArea" tabindex="0" aria-label="Typing area">
        <div class="passage" id="passage"></div>
        <div class="progress" title="Progress"><i id="progressBar"></i></div>
      </div>

      <div style="display:flex; gap:12px; margin-top:10px; align-items:center;">
        <div style="flex:1;">
          <div class="small">Type into the area above. Mistyped chars are highlighted red.</div>
        </div>
        <div style="text-align:right;">
          <div class="small">High score: <strong id="highScore">—</strong> WPM</div>
        </div>
      </div>

      <!-- virtual keyboard -->
      <div class="keyboard card" id="virtualKeyboard" aria-hidden="false">
        <div class="row" id="row1"></div>
        <div class="row" id="row2"></div>
        <div class="row" id="row3"></div>
        <div class="row" id="row4"></div>
      </div>
    </section>

    <!-- right column -->
    <aside class="right-col">
      <div class="card settings">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Controls & Help</strong>
          <small class="small">Enter to start/pause • Esc to reset</small>
        </div>
        <div class="small">
          <ul>
            <li>Choose <em>Time</em> mode for repeated sprints. Choose <em>Full passage</em> to finish the text.</li>
            <li>Virtual keyboard highlights the <strong>next</strong> key to press.</li>
            <li>High score is stored locally per lesson+mode+time.</li>
          </ul>
        </div>
      </div>

      <div class="card history">
        <strong>Mistakes review</strong>
        <div class="list" id="mistakeList"><div class="small">No mistakes yet — keep going!</div></div>
      </div>

      <div class="card history">
        <strong>Recent runs</strong>
        <div class="list" id="runHistory"><div class="small">No runs yet</div></div>
      </div>
    </aside>

    <footer class="small">Single-file typing trainer • No tracking • Local high scores only</footer>
  </div>

<script>
(() => {
  // --- Text data (lessons)
  const LESSONS = {
    home: "f j k l d s a ; f j k l d s a ; f j k l d s a ; home row practice.",
    pangram: "The quick brown fox jumps over the lazy dog. Practice keeps typing muscles quick and precise.",
    advanced: "Accuracy and rhythm matter more than sheer speed. Build consistent practice, and watch improvement appear steadily over days."
  };

  // --- DOM
  const passageEl = document.getElementById('passage');
  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');
  const lessonSelect = document.getElementById('lessonSelect');
  const modeSelect = document.getElementById('modeSelect');
  const timeInput = document.getElementById('timeInput');
  const soundToggle = document.getElementById('soundToggle');
  const darkToggle = document.getElementById('darkToggle');
  const wpmDisplay = document.getElementById('wpmDisplay');
  const accDisplay = document.getElementById('accDisplay');
  const timeDisplay = document.getElementById('timeDisplay');
  const typedDisplay = document.getElementById('typedDisplay');
  const progressBar = document.getElementById('progressBar');
  const mistakeList = document.getElementById('mistakeList');
  const runHistory = document.getElementById('runHistory');
  const highScoreEl = document.getElementById('highScore');
  const typingArea = document.getElementById('typingArea');

  // --- Virtual keyboard rows
  const q1 = "q w e r t y u i o p".split(" ");
  const q2 = "a s d f g h j k l ;".split(" ");
  const q3 = "z x c v b n m , . /".split(" ");
  const row1 = document.getElementById('row1'), row2 = document.getElementById('row2'), row3 = document.getElementById('row3'), row4 = document.getElementById('row4');

  function makeKey(k){ const el = document.createElement('div'); el.className='key'; el.textContent = k; el.dataset.key=k; return el; }
  [q1,q2,q3].forEach((r,i)=> {
    const container = [row1,row2,row3][i];
    r.forEach(k => container.appendChild(makeKey(k)));
  });
  // Row4: spacebar and shift visuals
  const space = document.createElement('div'); space.className='key'; space.style.minWidth='220px'; space.textContent='Space'; row4.appendChild(makeKey('Shift')); row4.appendChild(space); row4.appendChild(makeKey('Enter'));

  // --- State
  let chars = []; // array of char objects {char, status: 'pending'|'correct'|'incorrect'}
  let position = 0;
  let started = false;
  let paused = false;
  let startTime = 0;
  let elapsed = 0; // ms
  let timerId = null;
  let totalTyped = 0;
  let correctTyped = 0;
  let mistakes = []; // {pos, expected, got}
  let mode = 'time';
  let timeLimit = 30; // seconds
  let soundEnabled = true;

  // helpers
  const clamp = (v,a,b)=> Math.min(b, Math.max(a,v));
  const formatTime = s => {
    const mm = Math.floor(s/60).toString().padStart(2,'0');
    const ss = Math.floor(s%60).toString().padStart(2,'0');
    return `${mm}:${ss}`;
  };

  // --- Initialize passage
  function loadLesson(){
    const key = lessonSelect.value;
    const raw = LESSONS[key] || LESSONS.home;
    chars = raw.split('').map(ch => ({char:ch, status:'pending'}));
    position = 0;
    totalTyped = 0;
    correctTyped = 0;
    mistakes = [];
    renderPassage();
    setProgress();
    updateStats();
    loadHighScore();
    updateMistakeList();
  }

  function renderPassage(){
    passageEl.innerHTML = '';
    chars.forEach((c,i) => {
      const span = document.createElement('span');
      span.className = 'char';
      span.dataset.i = i;
      span.textContent = c.char === ' ' ? '\u00B7' : c.char; // middle dot for spaces
      if(c.status==='correct') span.classList.add('correct');
      if(c.status==='incorrect') span.classList.add('incorrect');
      if(i===position) span.classList.add('next');
      passageEl.appendChild(span);
    });
  }

  function setProgress(){
    const pct = chars.length ? (position / chars.length) * 100 : 0;
    progressBar.style.width = pct + '%';
  }

  function updateStats(){
    const secsElapsed = Math.max(1, elapsed / 1000);
    const minutes = secsElapsed / 60;
    const wpm = Math.round((correctTyped / 5) / minutes) || 0;
    const accuracy = totalTyped ? Math.round(100 * (correctTyped / totalTyped)) : 100;
    wpmDisplay.textContent = wpm;
    accDisplay.textContent = accuracy + '%';
    typedDisplay.textContent = totalTyped;
    // time display
    if(mode === 'time'){
      const remaining = Math.max(0, timeLimit - Math.floor(elapsed/1000));
      timeDisplay.textContent = formatTime(remaining);
    } else {
      // passage mode: show elapsed time
      timeDisplay.textContent = formatTime(Math.floor(elapsed/1000));
    }
  }

  // --- keyboard hint
  function highlightNextKey(){
    // remove previous hints
    document.querySelectorAll('.key.hint').forEach(k=>k.classList.remove('hint'));
    const nextChar = chars[position] ? chars[position].char : '';
    if(!nextChar) return;
    const ch = nextChar.toLowerCase();
    // mapping space -> Space, enter -> Enter, semicolon ; is shown as ;
    const target = Array.from(document.querySelectorAll('.key')).find(k => {
      const key = k.dataset.key.toLowerCase();
      if(ch === ' ') return key === 'space';
      if(ch === '\n' || ch === '\r') return key === 'enter';
      // map punctuation: , . / ; etc
      return key === ch || key === (ch === ';' ? ';' : ch);
    });
    if(target) target.classList.add('hint');
  }

  // --- high score key
  function highScoreKey(){
    return `tt_high_${lessonSelect.value}_${modeSelect.value}_${timeInput.value}`;
  }
  function loadHighScore(){
    const hs = localStorage.getItem(highScoreKey());
    highScoreEl.textContent = hs ? hs : '—';
  }
  function maybeSaveHighScore(wpm){
    const key = highScoreKey();
    const prev = Number(localStorage.getItem(key) || 0);
    if(wpm > prev){
      localStorage.setItem(key, String(wpm));
      loadHighScore();
    }
    // append run history
    const runs = JSON.parse(localStorage.getItem('tt_runs')||'[]');
    runs.unshift({when: Date.now(), lesson: lessonSelect.value, mode: modeSelect.value, time: timeInput.value, wpm});
    localStorage.setItem('tt_runs', JSON.stringify(runs.slice(0,20)));
    renderRuns();
  }

  function renderRuns(){
    const runs = JSON.parse(localStorage.getItem('tt_runs')||'[]');
    runHistory.innerHTML = '';
    if(!runs.length){ runHistory.innerHTML = '<div class="small">No runs yet</div>'; return; }
    runs.slice(0,8).forEach(r=>{
      const d = new Date(r.when);
      const node = document.createElement('div');
      node.className='small';
      node.textContent = `${d.toLocaleString()} — ${r.lesson}/${r.mode}@${r.time}s → ${r.wpm} WPM`;
      runHistory.appendChild(node);
    });
  }

  // --- mistakes UI
  function updateMistakeList(){
    mistakeList.innerHTML = '';
    if(!mistakes.length){ mistakeList.innerHTML = '<div class="small">No mistakes yet — keep going!</div>'; return; }
    mistakes.forEach(m=>{
      const node = document.createElement('div');
      node.innerHTML = `<div class="small">pos ${m.pos}: expected <strong>${escapeHtml(m.expected)}</strong> got <strong>${escapeHtml(m.got)}</strong></div>`;
      mistakeList.appendChild(node);
    });
  }

  function escapeHtml(s){
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // --- timer
  function tick(){
    elapsed = Date.now() - startTime;
    if(mode === 'time'){
      if(elapsed/1000 >= timeLimit){
        // finish
        stop(true);
        return;
      }
    } else {
      // passage mode: stop when position >= chars.length
      if(position >= chars.length){
        stop(true);
        return;
      }
    }
    updateStats();
    setProgress();
    highlightNextKey();
  }

  // --- start / stop / reset
  function start(){
    if(started && !paused) return;
    if(!started){
      startTime = Date.now();
      elapsed = 0;
      started = true;
      paused = false;
      startBtn.textContent = 'Pause';
      timerId = setInterval(tick, 100);
      typingArea.focus();
    } else {
      // resume
      paused = false;
      startBtn.textContent = 'Pause';
      startTime = Date.now() - elapsed;
      timerId = setInterval(tick, 100);
      typingArea.focus();
    }
  }
  function pause(){
    if(!started || paused) return;
    paused = true;
    clearInterval(timerId);
    elapsed = Date.now() - startTime;
    startBtn.textContent = 'Resume';
    updateStats();
  }
  function stop(autoFinish=false){
    if(!started) return;
    clearInterval(timerId);
    elapsed = Date.now() - startTime;
    started = false;
    paused = false;
    startBtn.textContent = 'Start';
    // final stats
    updateStats();
    const secs = Math.max(1, elapsed / 1000);
    const minutes = secs / 60;
    const wpm = Math.round((correctTyped / 5) / minutes) || 0;
    maybeSaveHighScore(wpm);
    // flash final
    if(autoFinish){
      // brief highlight on passage end
      if(soundEnabled) beep(380, 0.06);
    }
  }

  function reset(){
    clearInterval(timerId);
    started = false; paused = false;
    startBtn.textContent = 'Start';
    elapsed = 0; totalTyped = 0; correctTyped = 0; mistakes = [];
    loadLesson();
    updateMistakeList();
    updateStats();
  }

  // --- typing handling
  function handleKey(e){
    if(!started && e.key !== 'Tab' && e.key !== 'Shift' && e.key !== 'Meta') {
      // start automatically on first real key (except modifiers)
      // But user may prefer Enter to start — we map Enter to start/pause below. Here we auto-start on typing.
      start();
    }
    if(!started || paused) {
      if(e.key === 'Enter' && !started) { start(); e.preventDefault(); return; }
      if(e.key === 'Enter' && paused) { start(); e.preventDefault(); return; }
    }
    // map key to char
    let key = e.key;
    // unify the space
    if(key === ' ') key = ' ';
    if(key === 'Enter') key = '\n';
    // get expected char
    const expected = chars[position] ? chars[position].char : null;
    if(expected === null){
      // nothing left
      e.preventDefault();
      return;
    }
    // allow shift/ctrl/alt to pass
    if(e.key.length > 1 && e.key !== ' ' && e.key !== 'Enter') {
      // ignore other special keys
      if(e.key === 'Backspace') {
        // allow backspace to fix: go back if we had typed something
        if(position > 0){
          // revert last typed char status
          position--;
          const c = chars[position];
          if(c.status === 'correct') correctTyped--;
          if(c.status === 'incorrect'){
            // remove one matching mistake (last)
            mistakes = mistakes.filter(m => m.pos !== position);
          }
          c.status = 'pending';
          totalTyped = Math.max(0, totalTyped - 1);
          renderPassage();
          setProgress();
          updateStats();
          highlightNextKey();
        }
        e.preventDefault();
      }
      return;
    }

    // prevent default input behaviors
    e.preventDefault();
    totalTyped++;
    const got = key;
    if(got === expected){
      chars[position].status = 'correct';
      correctTyped++;
    } else {
      chars[position].status = 'incorrect';
      mistakes.push({pos: position, expected: expected, got: got});
      if(soundEnabled) beep(220, 0.03);
    }
    position++;
    renderPassage();
    setProgress();
    updateStats();
    updateMistakeList();
    highlightNextKey();

    // if reached end in passage mode
    if(mode === 'passage' && position >= chars.length){
      stop(true);
    }
  }

  // simple beep using WebAudio
  let audioCtx = null;
  function beep(freq=440, duration=0.05){
    if(!soundToggle.checked) return;
    try{
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type = 'sine'; o.frequency.value = freq;
      g.gain.value = 0.08;
      o.start();
      setTimeout(()=>{ o.stop(); }, duration*1000);
    }catch(e){}
  }

  // --- UI events
  startBtn.addEventListener('click', ()=> {
    if(!started) start(); else if(paused) start(); else pause();
  });
  resetBtn.addEventListener('click', ()=> reset());
  lessonSelect.addEventListener('change', ()=> { loadLesson(); });
  modeSelect.addEventListener('change', ()=> { mode = modeSelect.value; loadLesson(); });
  timeInput.addEventListener('input', ()=> { timeLimit = Math.max(5, Number(timeInput.value) || 30); loadHighScore(); });
  soundToggle.addEventListener('change', ()=> { soundEnabled = soundToggle.checked; });
  darkToggle.addEventListener('change', ()=> { document.documentElement.setAttribute('data-theme', darkToggle.checked ? 'dark' : ''); });

  // global key handling (on body) to capture quickly
  window.addEventListener('keydown', (e) => {
    // shortcuts
    if(e.key === 'Escape'){ reset(); e.preventDefault(); return; }
    if(e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey){
      // Toggle start/pause
      if(!started) start();
      else if(paused) start();
      else pause();
      e.preventDefault();
      return;
    }
    // only handle printable chars and backspace
    handleKey(e);
  });

  // focus typing area when clicked
  typingArea.addEventListener('click', ()=> typingArea.focus());
  typingArea.addEventListener('focus', ()=> typingArea.classList.add('focused'));
  typingArea.addEventListener('blur', ()=> typingArea.classList.remove('focused'));

  // prevent selecting text
  passageEl.addEventListener('selectstart', e => e.preventDefault());

  // initial setup
  function init(){
    mode = modeSelect.value;
    timeLimit = Number(timeInput.value);
    loadLesson();
    renderRuns();
    highlightNextKey();
    updateStats();
  }
  init();

})();
</script>
</body>
</html>
